<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>RouteMaster PRO | Developer Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <style>
        #map { height: 600px; width: 100%; border-radius: 1.5rem; }
        #dropZone.dragover { border-color: #2563eb; background-color: #eff6ff; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        
        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1.5rem;
            border-radius: 1rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            max-height: 400px;
        }

        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
        .tab-inactive { color: #64748b; }

        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 1; }
            80%, 100% { opacity: 0; }
        }
        
        /* Custom Leaflet Marker Styles */
        .start-marker {
            background: #22c55e;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .click-marker {
            background: #f59e0b;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }
        
        /* Coordinate Panel */
        .coord-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(8px);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 220px;
            transition: all 0.3s ease;
        }
        
        .coord-panel.hidden-panel {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        
        /* Custom Leaflet Control Styles */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15) !important;
        }
        
        .leaflet-control-zoom a {
            background: white !important;
            color: #334155 !important;
            border: none !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: #f1f5f9 !important;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1e293b;
            color: white;
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-weight: 600;
            z-index: 9999;
            transition: transform 0.4s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 overflow-x-hidden">

<nav class="bg-white/90 backdrop-blur-md border-b border-slate-200 sticky top-0 z-[1000]">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg text-white shadow-lg shadow-blue-200">
                <span class="material-symbols-outlined leading-none">terminal</span>
            </div>
            <div>
                <h1 class="font-black text-xl tracking-tight text-slate-800">RouteMaster <span class="text-blue-600">Dev</span></h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">OSM-to-GPX Pipeline</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button class="text-slate-500 hover:text-blue-600 text-sm font-bold transition px-4 py-2" onclick="scrollToSection('dev-zone')">Dev Zone</button>
            <button id="nav-download-gpx" onclick="downloadGPX()" 
                    class="bg-blue-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-700 transition items-center gap-2 shadow-lg shadow-blue-200 hidden"
                    title="Download route as GPX file">
                <span class="material-symbols-outlined text-lg">download</span>
                Download GPX
            </button>
            <label class="bg-slate-900 text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-800 transition flex items-center gap-2 cursor-pointer shadow-xl shadow-slate-200" for="osm-upload">
                <span class="material-symbols-outlined text-lg">upload_file</span>
                Load OSM
                <input accept=".osm,.xml" class="hidden" id="osm-upload" onchange="handleFileUpload(event)" type="file">
            </label>
        </div>
    </div>
</nav>

<main class="max-w-7xl mx-auto px-6 py-10 space-y-12">
    <!-- Hero / Metrics Section -->
    <section class="grid lg:grid-cols-12 gap-8">
        <div class="lg:col-span-8 space-y-6">
            <div class="space-y-2">
                <h2 class="text-5xl font-black text-slate-900 tracking-tight leading-tight">
                    Smart Collection. <br>
                    <span class="text-blue-600 underline decoration-blue-100 underline-offset-8">Zero Driveways.</span>
                </h2>
                <p class="text-slate-500 text-lg max-w-2xl leading-relaxed">
                    Municipal-grade routing engine that filters OpenStreetMap data to generate a continuous, 100% right-side collection track.
                </p>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Coverage</p>
                    <p class="text-2xl font-black text-slate-800" id="stat-ways">0 Ways</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Track Distance</p>
                    <p class="text-2xl font-black text-slate-800" id="stat-dist">0.00 km</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Complexity</p>
                    <p class="text-2xl font-black text-slate-800" id="stat-complexity">O(E+V)</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Engine State</p>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-300 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-slate-400" id="status-dot"></span>
                        </span>
                        <span class="text-[10px] font-bold text-slate-500 uppercase" id="status-text">Idle</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="lg:col-span-4 bg-slate-900 rounded-[2rem] p-8 text-white relative overflow-hidden shadow-2xl">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-900/30 to-slate-900/50"></div>
            <div class="relative z-10 flex flex-col justify-between h-full space-y-4">
                <div class="bg-blue-600 w-12 h-12 rounded-xl flex items-center justify-center">
                    <span class="material-symbols-outlined">analytics</span>
                </div>
                <h3 class="text-xl font-bold">Logic: Double-Traverse</h3>
                <p class="text-slate-400 text-xs leading-relaxed">
                    Standard routing finds the shortest path. We find the <strong>Eulerian Circuit</strong> on a directed graph where every undirected residential way is represented twice to collect from both sides.
                </p>
                <div class="pt-4 border-t border-slate-800">
                    <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Parser active: Filter(service!=driveway)</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Start Point Configuration Panel -->
    <section class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-green-100 p-2 rounded-lg text-green-600">
                    <span class="material-symbols-outlined">location_on</span>
                </div>
                <div>
                    <h3 class="font-bold text-slate-800">Custom Start Point</h3>
                    <p class="text-xs text-slate-500">Click on map or enter coordinates manually</p>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2">
                    <label class="text-xs font-bold text-slate-500">LAT:</label>
                    <input type="number" step="any" id="input-lat" placeholder="40.7128" 
                           class="w-28 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           onchange="updateStartFromInput()">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs font-bold text-slate-500">LNG:</label>
                    <input type="number" step="any" id="input-lng" placeholder="-74.006" 
                           class="w-28 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           onchange="updateStartFromInput()">
                </div>
                <button onclick="setStartPointMode()" id="btn-set-start"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 transition flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">ads_click</span>
                    <span id="btn-set-start-text">Set via Map Click</span>
                </button>
                <button onclick="clearStartPoint()" 
                        class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-200 transition">
                    Clear
                </button>
            </div>
        </div>
        
        <div id="start-point-info" class="mt-4 hidden">
            <div class="flex items-center gap-2 text-sm text-green-600 font-medium">
                <span class="material-symbols-outlined text-lg">check_circle</span>
                <span>Start point set: <span id="start-coords-display" class="font-mono"></span></span>
            </div>
        </div>
    </section>

    <!-- Share & URL Section -->
    <section class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
            <div class="flex items-center gap-3">
                <div class="bg-purple-100 p-2 rounded-lg text-purple-600">
                    <span class="material-symbols-outlined">share</span>
                </div>
                <div>
                    <h3 class="font-bold text-slate-800">Share & Load from URL</h3>
                    <p class="text-xs text-slate-500">Generate shareable links or load OSM data from URL</p>
                </div>
            </div>
            
            <button onclick="copyShareURL()" 
                    class="bg-purple-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-purple-700 transition flex items-center gap-2">
                <span class="material-symbols-outlined text-lg">link</span>
                Copy Share Link
            </button>
        </div>
        
        <!-- Generated Share URL Display -->
        <div class="mb-4">
            <label class="text-xs font-bold text-slate-500 block mb-2">SHAREABLE URL (includes map position & start point)</label>
            <div class="flex gap-2">
                <input type="text" id="share-url-display" readonly
                       class="flex-1 px-4 py-3 text-sm border border-slate-200 rounded-lg bg-slate-50 font-mono text-slate-600"
                       onclick="this.select()">
                <button onclick="copyShareURL()" 
                        class="bg-slate-100 text-slate-600 px-4 py-3 rounded-lg hover:bg-slate-200 transition">
                    <span class="material-symbols-outlined">content_copy</span>
                </button>
            </div>
        </div>
        
        <!-- Load from URL -->
        <div class="pt-4 border-t border-slate-100">
            <label class="text-xs font-bold text-slate-500 block mb-2">LOAD OSM DATA FROM URL</label>
            <div class="flex gap-2">
                <input type="url" id="input-osm-url" placeholder="https://example.com/data.osm or Overpass API URL..." 
                       class="flex-1 px-4 py-3 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                       onkeypress="if(event.key === 'Enter') loadFromURL()">
                <button onclick="loadFromURL()" 
                        class="bg-slate-900 text-white px-5 py-3 rounded-lg text-sm font-bold hover:bg-slate-800 transition flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">cloud_download</span>
                    Load
                </button>
            </div>
            <p class="text-xs text-slate-400 mt-2">
                Supports: Direct .osm file URLs, Overpass API endpoints, or any URL returning OSM XML data
            </p>
        </div>
        
        <!-- URL Parameters Reference -->
        <div class="mt-4 pt-4 border-t border-slate-100">
            <details class="text-sm">
                <summary class="cursor-pointer text-slate-500 font-medium hover:text-slate-700">
                    URL Parameters Reference
                </summary>
                <div class="mt-3 bg-slate-50 rounded-lg p-4 font-mono text-xs text-slate-600 space-y-1">
                    <p><span class="text-purple-600">lat</span>=40.7128 — Map center latitude</p>
                    <p><span class="text-purple-600">lng</span>=-74.006 — Map center longitude</p>
                    <p><span class="text-purple-600">zoom</span>=14 — Map zoom level (1-19)</p>
                    <p><span class="text-purple-600">startLat</span>=40.712 — Start point latitude</p>
                    <p><span class="text-purple-600">startLng</span>=-74.005 — Start point longitude</p>
                    <p><span class="text-purple-600">osmUrl</span>=https://... — Auto-load OSM data from URL</p>
                </div>
            </details>
        </div>
    </section>

    <!-- Map Playground -->
    <section class="relative bg-white rounded-[2.5rem] border-8 border-white shadow-2xl shadow-slate-200 overflow-hidden" id="dropZone">
        <div id="map"></div>
        
        <!-- Coordinate Display Panel (shows on map click) -->
        <div id="coord-panel" class="coord-panel hidden-panel">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold text-slate-500 uppercase tracking-wide">Clicked Location</span>
                <button onclick="hideCoordPanel()" class="text-slate-400 hover:text-slate-600">
                    <span class="material-symbols-outlined text-sm">close</span>
                </button>
            </div>
            <div class="space-y-1 mb-3">
                <p class="text-sm font-mono text-slate-800">
                    <span class="text-slate-500">Lat:</span> <span id="click-lat">--</span>
                </p>
                <p class="text-sm font-mono text-slate-800">
                    <span class="text-slate-500">Lng:</span> <span id="click-lng">--</span>
                </p>
            </div>
            <div class="flex gap-2">
                <button onclick="useAsStartPoint()" 
                        class="flex-1 bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-700 transition">
                    Use as Start
                </button>
                <button onclick="copyCoordinates()" 
                        class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-slate-200 transition">
                    <span class="material-symbols-outlined text-sm">content_copy</span>
                </button>
            </div>
        </div>
        
        <!-- UI Overlays -->
        <div class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-slate-50/95 backdrop-blur-sm" id="overlay-initial">
            <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-6">
                <span class="material-symbols-outlined text-4xl">map_search</span>
            </div>
            <h3 class="text-2xl font-black text-slate-800 mb-2">Awaiting OSM Topology</h3>
            <p class="text-slate-500 mb-8 max-w-sm text-center">Export a neighborhood from OpenStreetMap and drag the .osm file here to generate your collection track.</p>
            <button class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-bold hover:bg-blue-700 transition shadow-xl shadow-blue-200" onclick="document.getElementById('osm-upload').click()">Browse Local Files</button>
        </div>

        <div class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-white/95 hidden" id="overlay-loading">
            <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="font-black text-xl text-slate-800" id="loading-title">Parsing Infrastructure...</p>
            <p class="text-slate-500 mt-2" id="loading-subtitle">Applying Hierholzer's Algorithm</p>
        </div>

        <!-- Floating Actions -->
        <div class="absolute bottom-10 left-1/2 -translate-x-1/2 z-30 flex gap-4 hidden" id="floating-actions">
            <button class="bg-blue-600 text-white px-8 py-5 rounded-2xl font-black text-lg hover:bg-blue-700 shadow-2xl flex items-center gap-3 transition-transform active:scale-95" onclick="downloadGPX()">
                <span class="material-symbols-outlined text-2xl">download</span>
                Download GPX
            </button>
            <button class="bg-white text-slate-500 border border-slate-200 px-6 py-5 rounded-2xl font-bold hover:bg-slate-50 shadow-xl flex items-center gap-3 transition-transform active:scale-95" onclick="resetApp()">
                <span class="material-symbols-outlined">restart_alt</span>
                Reset
            </button>
        </div>
    </section>

    <!-- Developer Zone / Code Export Section -->
    <section class="space-y-8 py-10 border-t border-slate-200" id="dev-zone">
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-slate-900 p-3 rounded-xl text-white">
                    <span class="material-symbols-outlined leading-none">code</span>
                </div>
                <div>
                    <h3 class="text-3xl font-black text-slate-800 tracking-tight">App Source Code</h3>
                    <p class="text-slate-500 font-medium">Export this entire application as a single-file portable tool.</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button class="bg-slate-900 text-white px-6 py-4 rounded-2xl font-bold hover:bg-slate-800 flex items-center gap-2 shadow-xl transition active:scale-95" onclick="downloadAppSource()">
                    <span class="material-symbols-outlined">file_download</span>
                    Export App Source (.html)
                </button>
                <button class="bg-white text-slate-600 border border-slate-200 px-6 py-4 rounded-2xl font-bold hover:bg-slate-50 flex items-center gap-2 shadow-sm transition" onclick="copyCodeSnippet()">
                    <span class="material-symbols-outlined">content_copy</span>
                    Copy JS Logic
                </button>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm space-y-4">
                <h4 class="font-bold text-xl flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-600">settings_ethernet</span>
                    The Algorithm
                </h4>
                <p class="text-slate-600 text-sm leading-relaxed">
                    This app implements <strong>Hierholzer's Algorithm</strong> for Eulerian Circuits. It maps an undirected neighborhood into a balanced directed graph by doubling every edge.
                </p>
                <ul class="space-y-2 text-xs text-slate-500">
                    <li class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-blue-600"></span>
                        O(V+E) Linear Complexity
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-blue-600"></span>
                        Graph Doubling ensures In-Degree = Out-Degree
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-blue-600"></span>
                        Custom Tag Filtering for Driveway Removal
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-600"></span>
                        Custom Start Point Support
                    </li>
                </ul>
            </div>
            <div class="bg-slate-900 p-6 rounded-[2.5rem] relative group shadow-2xl">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Logic Preview (Hierholzer)</span>
                    <span class="text-blue-500 font-mono text-xs">EulerCircuit.js</span>
                </div>
                <div class="code-block custom-scrollbar" id="code-snippet-preview">
<pre><code>// Euler Circuit Generation with Custom Start
function computeCircuit(startNode, adjacencyMap) {
    let stack = [startNode];
    let circuit = [];
    let localAdj = clone(adjacencyMap);

    while (stack.length > 0) {
        let u = stack[stack.length - 1];
        if (localAdj.get(u)?.length > 0) {
            let v = localAdj.get(u).pop();
            stack.push(v);
        } else {
            circuit.push(stack.pop());
        }
    }
    return circuit.reverse();
}

// Find nearest node to custom start point
function findNearestNode(lat, lng, nodeMap) {
    let minDist = Infinity;
    let nearestId = null;
    for (let [id, coords] of nodeMap) {
        let d = haversine(coords, {lat, lng});
        if (d < minDist) {
            minDist = d;
            nearestId = id;
        }
    }
    return nearestId;
}</code></pre>
                </div>
                <div class="absolute inset-0 bg-slate-900/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center pointer-events-none rounded-[2.5rem]">
                    <span class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold">Read-Only Preview</span>
                </div>
            </div>
        </div>
    </section>
</main>

<footer class="bg-slate-50 py-16 border-t border-slate-200">
    <div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-8">
        <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-blue-600">terminal</span>
            <span class="font-black text-slate-800">RouteMaster PRO <span class="text-slate-400 font-normal">| Dev Edition</span></span>
        </div>
        <p class="text-slate-400 text-xs text-center md:text-left">
            Built with Hierholzer Logic &amp; OpenStreetMap XML Parser. <br>
            Powered by Leaflet.js for interactive mapping.
        </p>
        <div class="flex gap-4">
            <a href="https://openstreetmap.org" target="_blank" class="text-slate-400 hover:text-blue-600 transition underline text-xs">OSM.org Source</a>
            <a href="https://leafletjs.com" target="_blank" class="text-slate-400 hover:text-blue-600 transition underline text-xs">Leaflet.js</a>
        </div>
    </div>
</footer>

<!-- Toast Notification -->
<div id="toast" class="toast">Toast message</div>

<script>
    // Global State
    let map;
    let routePolyline;
    let nodeMap = new Map();
    let adj = new Map();
    let generatedRoute = [];
    let customStartPoint = null;
    let startPointMarker = null;
    let clickMarker = null;
    let lastClickedCoords = null;
    let isSettingStartPoint = false;
    let osmDataLoaded = false;
    let cachedOSMData = null;

    // Initialize Leaflet Map
    function initMap() {
        map = L.map('map', {
            zoomControl: true
        }).setView([40.7128, -74.0060], 12);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Map click handler
        map.on('click', handleMapClick);
        
        // Update share URL when map moves
        map.on('moveend', updateShareURLDisplay);
        map.on('zoomend', updateShareURLDisplay);

        setupDragAndDrop();
        
        // Initial share URL display
        setTimeout(updateShareURLDisplay, 100);
    }
    
    // Update the share URL display field
    function updateShareURLDisplay() {
        const urlField = document.getElementById('share-url-display');
        if (urlField) {
            urlField.value = generateShareURL();
        }
    }

    // Handle map clicks
    function handleMapClick(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        lastClickedCoords = { lat, lng };

        // If in start point setting mode, set the start point
        if (isSettingStartPoint) {
            setStartPoint(lat, lng);
            setStartPointMode(); // Toggle off
            return;
        }

        // Show coordinate panel and marker
        showCoordPanel(lat, lng);
        
        // Add/update click marker
        if (clickMarker) {
            map.removeLayer(clickMarker);
        }
        
        const clickIcon = L.divIcon({
            className: 'click-marker',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });
        
        clickMarker = L.marker([lat, lng], { icon: clickIcon }).addTo(map);
    }

    // Show coordinate panel
    function showCoordPanel(lat, lng) {
        document.getElementById('click-lat').textContent = lat.toFixed(6);
        document.getElementById('click-lng').textContent = lng.toFixed(6);
        document.getElementById('coord-panel').classList.remove('hidden-panel');
    }

    // Hide coordinate panel
    function hideCoordPanel() {
        document.getElementById('coord-panel').classList.add('hidden-panel');
        if (clickMarker) {
            map.removeLayer(clickMarker);
            clickMarker = null;
        }
    }

    // Copy coordinates to clipboard
    function copyCoordinates() {
        if (lastClickedCoords) {
            const text = `${lastClickedCoords.lat.toFixed(6)}, ${lastClickedCoords.lng.toFixed(6)}`;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Coordinates copied to clipboard!');
            });
        }
    }

    // Use clicked location as start point
    function useAsStartPoint() {
        if (lastClickedCoords) {
            setStartPoint(lastClickedCoords.lat, lastClickedCoords.lng);
            hideCoordPanel();
        }
    }

    // Toggle start point setting mode
    function setStartPointMode() {
        isSettingStartPoint = !isSettingStartPoint;
        const btn = document.getElementById('btn-set-start');
        const btnText = document.getElementById('btn-set-start-text');
        
        if (isSettingStartPoint) {
            btn.classList.remove('bg-green-600', 'hover:bg-green-700');
            btn.classList.add('bg-amber-500', 'hover:bg-amber-600');
            btnText.textContent = 'Click on Map...';
            document.getElementById('map').style.cursor = 'crosshair';
            showToast('Click on the map to set start point');
        } else {
            btn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
            btnText.textContent = 'Set via Map Click';
            document.getElementById('map').style.cursor = '';
        }
    }

    // Set start point
    function setStartPoint(lat, lng) {
        customStartPoint = { lat, lng };
        
        // Update input fields
        document.getElementById('input-lat').value = lat.toFixed(6);
        document.getElementById('input-lng').value = lng.toFixed(6);
        
        // Update display
        document.getElementById('start-coords-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        document.getElementById('start-point-info').classList.remove('hidden');
        
        // Add/update marker
        if (startPointMarker) {
            map.removeLayer(startPointMarker);
        }
        
        const startIcon = L.divIcon({
            className: 'start-marker',
            iconSize: [20, 20],
            iconAnchor: [10, 10],
            html: '<div style="width:20px;height:20px;background:#22c55e;border:3px solid white;border-radius:50%;box-shadow:0 2px 10px rgba(0,0,0,0.3);"></div>'
        });
        
        startPointMarker = L.marker([lat, lng], { icon: startIcon })
            .addTo(map)
            .bindPopup('<strong>Start Point</strong><br>Circuit will begin here');
        
        showToast('Start point set successfully!');
        
        // Update share URL display
        updateShareURLDisplay();
        
        // If OSM data is already loaded, recompute the circuit
        if (osmDataLoaded && cachedOSMData) {
            recomputeCircuit();
        }
    }

    // Update start point from manual input
    function updateStartFromInput() {
        const lat = parseFloat(document.getElementById('input-lat').value);
        const lng = parseFloat(document.getElementById('input-lng').value);
        
        if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
            setStartPoint(lat, lng);
            map.setView([lat, lng], map.getZoom());
        }
    }

    // Clear start point
    function clearStartPoint() {
        customStartPoint = null;
        document.getElementById('input-lat').value = '';
        document.getElementById('input-lng').value = '';
        document.getElementById('start-point-info').classList.add('hidden');
        
        if (startPointMarker) {
            map.removeLayer(startPointMarker);
            startPointMarker = null;
        }
        
        showToast('Start point cleared');
        
        // Update share URL display
        updateShareURLDisplay();
        
        // Recompute if data loaded
        if (osmDataLoaded && cachedOSMData) {
            recomputeCircuit();
        }
    }

    // Toast notification
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 2500);
    }

    // Setup drag and drop
    function setupDragAndDrop() {
        const dz = document.getElementById('dropZone');
        dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('dragover'); });
        dz.addEventListener('dragleave', () => { dz.classList.remove('dragover'); });
        dz.addEventListener('drop', (e) => {
            e.preventDefault();
            dz.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) processFile(file);
    }

    function processFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            cachedOSMData = e.target.result;
            parseOSMData(cachedOSMData);
        };
        reader.readAsText(file);
    }

    function showLoading(show, title, sub) {
        const overlay = document.getElementById('overlay-loading');
        if (show) {
            document.getElementById('loading-title').innerText = title;
            document.getElementById('loading-subtitle').innerText = sub;
            overlay.classList.remove('hidden');
        } else {
            overlay.classList.add('hidden');
        }
    }

    async function parseOSMData(xmlString) {
        showLoading(true, "Scanning OSM XML...", "Stripping driveways and private access ways");
        
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");
            
            // Nodes Extraction
            nodeMap.clear();
            const nodes = xmlDoc.getElementsByTagName("node");
            for (let n of nodes) {
                nodeMap.set(n.getAttribute("id"), {
                    lat: parseFloat(n.getAttribute("lat")),
                    lng: parseFloat(n.getAttribute("lon"))
                });
            }

            // Ways Filtering & Graph Construction
            adj.clear();
            const ways = xmlDoc.getElementsByTagName("way");
            let count = 0;
            const validRoads = ["residential", "living_street", "unclassified", "tertiary", "secondary_link", "service"];

            for (let w of ways) {
                const tags = w.getElementsByTagName("tag");
                let highway = "";
                let service = "";
                let access = "";

                for (let t of tags) {
                    const k = t.getAttribute("k");
                    const v = t.getAttribute("v");
                    if (k === "highway") highway = v;
                    if (k === "service") service = v;
                    if (k === "access") access = v;
                }

                // Filtering driveways and private ways
                const isDriveway = (service === "driveway" || service === "parking_aisle");
                const isPrivate = (access === "private" || access === "no");
                
                if (validRoads.includes(highway) && !isDriveway && !isPrivate) {
                    const nds = w.getElementsByTagName("nd");
                    for (let i = 0; i < nds.length - 1; i++) {
                        const u = nds[i].getAttribute("ref");
                        const v = nds[i+1].getAttribute("ref");
                        
                        // Represent street as two directed edges
                        if (!adj.has(u)) adj.set(u, []);
                        if (!adj.has(v)) adj.set(v, []);
                        adj.get(u).push(v);
                        adj.get(v).push(u);
                    }
                    count++;
                }
            }

            if (count === 0) throw new Error("No valid residential streets found.");
            document.getElementById('stat-ways').innerText = `${count} Ways`;
            
            osmDataLoaded = true;
            await computeEulerCircuit();
        } catch (err) {
            alert("Parser Error: " + err.message);
            showLoading(false);
        }
    }

    // Recompute circuit when start point changes
    async function recomputeCircuit() {
        if (!osmDataLoaded) return;
        await computeEulerCircuit();
    }

    // Find nearest node to a given coordinate
    function findNearestNode(lat, lng) {
        let minDist = Infinity;
        let nearestId = null;
        
        for (let [id, coords] of nodeMap) {
            if (!adj.has(id)) continue; // Only consider nodes in our graph
            const d = haversine(coords, { lat, lng });
            if (d < minDist) {
                minDist = d;
                nearestId = id;
            }
        }
        return nearestId;
    }

    async function computeEulerCircuit() {
        showLoading(true, "Euler Circuit Solving...", "Balancing directed graph edges");
        await new Promise(r => setTimeout(r, 500));

        let localAdj = new Map();
        for (let [node, neighbors] of adj) {
            localAdj.set(node, [...neighbors]);
        }

        // Determine start node
        let startNode;
        if (customStartPoint) {
            startNode = findNearestNode(customStartPoint.lat, customStartPoint.lng);
            if (!startNode) {
                showToast('Custom start point too far from road network, using default');
                startNode = [...adj.keys()][0];
            }
        } else {
            startNode = [...adj.keys()][0];
        }

        let stack = [startNode];
        let circuit = [];

        while (stack.length > 0) {
            let u = stack[stack.length - 1];
            if (localAdj.has(u) && localAdj.get(u).length > 0) {
                let v = localAdj.get(u).pop();
                stack.push(v);
            } else {
                circuit.push(stack.pop());
            }
        }

        generatedRoute = circuit.map(id => nodeMap.get(id)).filter(p => !!p);
        renderRoute();
    }

    async function renderRoute() {
        // Remove existing polyline
        if (routePolyline) {
            map.removeLayer(routePolyline);
        }

        // Create route coordinates array for Leaflet
        const routeCoords = generatedRoute.map(pt => [pt.lat, pt.lng]);

        // Create polyline with Leaflet
        routePolyline = L.polyline(routeCoords, {
            color: '#2563eb',
            weight: 5,
            opacity: 0.85,
            lineJoin: 'round'
        }).addTo(map);

        // Add directional arrows using a decorated polyline pattern
        const arrowHead = L.polyline(routeCoords, {
            color: '#1d4ed8',
            weight: 3,
            opacity: 0.6,
            dashArray: '10, 20'
        }).addTo(map);

        // Calculate distance
        let dist = 0;
        for (let i = 0; i < generatedRoute.length - 1; i++) {
            dist += haversine(generatedRoute[i], generatedRoute[i+1]);
        }

        // Fit bounds
        if (routeCoords.length > 0) {
            map.fitBounds(routePolyline.getBounds(), { padding: [50, 50] });
        }

        // Add start/end markers
        if (generatedRoute.length > 0) {
            const startPt = generatedRoute[0];
            const endPt = generatedRoute[generatedRoute.length - 1];
            
            // Start marker (green)
            const startIcon = L.divIcon({
                html: '<div style="background:#22c55e;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                className: '',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            L.marker([startPt.lat, startPt.lng], { icon: startIcon })
                .addTo(map)
                .bindPopup('<strong>Route Start</strong>');
            
            // End marker (red)
            const endIcon = L.divIcon({
                html: '<div style="background:#ef4444;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                className: '',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            L.marker([endPt.lat, endPt.lng], { icon: endIcon })
                .addTo(map)
                .bindPopup('<strong>Route End</strong>');
        }

        document.getElementById('stat-dist').innerText = dist.toFixed(2) + " km";
        document.getElementById('status-dot').className = "relative inline-flex rounded-full h-3 w-3 bg-green-500";
        document.getElementById('status-text').innerText = "Live Track";
        document.getElementById('status-text').className = "text-[10px] font-bold text-green-600 uppercase";

        document.getElementById('overlay-initial').classList.add('hidden');
        document.getElementById('floating-actions').classList.remove('hidden');
        document.getElementById('nav-download-gpx').classList.remove('hidden');
        document.getElementById('nav-download-gpx').classList.add('flex');
        showLoading(false);
    }

    function haversine(p1, p2) {
        const R = 6371;
        const dLat = (p2.lat - p1.lat) * Math.PI / 180;
        const dLon = (p2.lng - p1.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function downloadGPX() {
        if (generatedRoute.length === 0) {
            showToast('No route to download. Please load an OSM file first.');
            return;
        }
        
        const timestamp = new Date().toISOString();
        const distance = document.getElementById('stat-dist').innerText;
        
        let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="RouteMasterPRO-Leaflet" 
     xmlns="http://www.topografix.com/GPX/1/1"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>Collection Route</name>
    <desc>Eulerian circuit for waste collection - generated by RouteMaster PRO</desc>
    <time>${timestamp}</time>
  </metadata>
  <trk>
    <name>Continuous Collection Loop</name>
    <desc>Total distance: ${distance}</desc>
    <trkseg>`;
        
        generatedRoute.forEach((pt, idx) => {
            gpx += `
      <trkpt lat="${pt.lat.toFixed(7)}" lon="${pt.lng.toFixed(7)}">
        <ele>0</ele>
      </trkpt>`;
        });
        
        gpx += `
    </trkseg>
  </trk>
</gpx>`;
        
        const blob = new Blob([gpx], { type: 'application/gpx+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Collection_Route_${new Date().getTime()}.gpx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('GPX file downloaded successfully!');
    }

    function downloadAppSource() {
        const html = document.documentElement.outerHTML;
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `RouteMaster_PRO_Source.html`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function copyCodeSnippet() {
        const code = document.getElementById('code-snippet-preview').innerText;
        navigator.clipboard.writeText(code).then(() => {
            showToast("Algorithm code copied to clipboard!");
        });
    }

    function resetApp() {
        generatedRoute = [];
        osmDataLoaded = false;
        cachedOSMData = null;
        
        // Clear all layers except base tile layer
        map.eachLayer((layer) => {
            if (!(layer instanceof L.TileLayer)) {
                map.removeLayer(layer);
            }
        });
        
        // Re-add start point marker if exists
        if (customStartPoint && startPointMarker) {
            startPointMarker.addTo(map);
        }
        
        routePolyline = null;
        
        document.getElementById('overlay-initial').classList.remove('hidden');
        document.getElementById('floating-actions').classList.add('hidden');
        document.getElementById('nav-download-gpx').classList.add('hidden');
        document.getElementById('nav-download-gpx').classList.remove('flex');
        document.getElementById('stat-dist').innerText = "0.00 km";
        document.getElementById('stat-ways').innerText = "0 Ways";
        document.getElementById('status-dot').className = "relative inline-flex rounded-full h-3 w-3 bg-slate-400";
        document.getElementById('status-text').innerText = "Idle";
        document.getElementById('status-text').className = "text-[10px] font-bold text-slate-500 uppercase";
        
        // Reset file input
        document.getElementById('osm-upload').value = '';
    }

    function scrollToSection(id) {
        document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
    }

    // ========== URL PARAMETER HANDLING ==========
    
    // Parse URL parameters on load
    function parseURLParameters() {
        const params = new URLSearchParams(window.location.search);
        
        // Get map center and zoom
        const lat = parseFloat(params.get('lat'));
        const lng = parseFloat(params.get('lng'));
        const zoom = parseInt(params.get('zoom'));
        
        if (!isNaN(lat) && !isNaN(lng)) {
            map.setView([lat, lng], !isNaN(zoom) ? zoom : 14);
        }
        
        // Get custom start point
        const startLat = parseFloat(params.get('startLat'));
        const startLng = parseFloat(params.get('startLng'));
        
        if (!isNaN(startLat) && !isNaN(startLng)) {
            setStartPoint(startLat, startLng);
        }
        
        // Get OSM data URL
        const osmUrl = params.get('osmUrl');
        if (osmUrl) {
            loadFromURL(osmUrl);
        }
    }
    
    // Generate shareable URL with current settings
    function generateShareURL() {
        const baseUrl = window.location.origin + window.location.pathname;
        const params = new URLSearchParams();
        
        // Add map center and zoom
        const center = map.getCenter();
        params.set('lat', center.lat.toFixed(6));
        params.set('lng', center.lng.toFixed(6));
        params.set('zoom', map.getZoom());
        
        // Add start point if set
        if (customStartPoint) {
            params.set('startLat', customStartPoint.lat.toFixed(6));
            params.set('startLng', customStartPoint.lng.toFixed(6));
        }
        
        return baseUrl + '?' + params.toString();
    }
    
    // Copy share URL to clipboard
    function copyShareURL() {
        const url = generateShareURL();
        navigator.clipboard.writeText(url).then(() => {
            showToast('Share URL copied to clipboard!');
        });
    }
    
    // Load OSM data from URL
    async function loadFromURL(url) {
        if (!url) {
            url = document.getElementById('input-osm-url')?.value;
        }
        
        if (!url) {
            showToast('Please enter a URL');
            return;
        }
        
        showLoading(true, "Fetching OSM Data...", "Loading from remote URL");
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.text();
            cachedOSMData = data;
            parseOSMData(data);
            showToast('OSM data loaded from URL!');
        } catch (err) {
            showLoading(false);
            showToast('Failed to load: ' + err.message);
            console.error('URL load error:', err);
        }
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        // Parse URL parameters after map is ready
        setTimeout(parseURLParameters, 500);
    });
</script>

</body>
</html>
